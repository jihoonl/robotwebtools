(function(e,t){typeof define=="function"&&define.amd?define(["eventemitter2"],t):e.ROS=t(e.EventEmitter2)})(this,function(e){var t=function(t){function r(e){n.emit("connection",e)}function i(e){n.emit("close",e)}function s(e){n.emit("error",e)}function o(e,t){var n=new Image;n.onload=function(){var e=document.createElement("canvas"),r=e.getContext("2d");e.width=n.width,e.height=n.height,r.drawImage(n,0,0);var i=r.getImageData(0,0,n.width,n.height).data,s="";for(var o=0;o<i.length;o+=4)s+=String.fromCharCode(i[o],i[o+1],i[o+2]);var u=JSON.parse(s);t(u)},n.src="data:image/png;base64,"+e.data}function u(e){function t(e){e.op==="publish"?n.emit(e.topic,e.msg):e.op==="service_response"&&n.emit(e.id,e.values)}var r=JSON.parse(e.data);r.op==="png"?o(r,function(e){t(e)}):t(r)}function a(e){var t=JSON.stringify(e);n.socket.readyState!==WebSocket.OPEN?n.once("connection",function(){n.socket.send(t)}):n.socket.send(t)}var n=this;n.socket=null,n.idCounter=0,n.connect=function(e){n.socket=new WebSocket(e),n.socket.onopen=r,n.socket.onclose=i,n.socket.onerror=s,n.socket.onmessage=u},n.close=function(){n.socket&&n.socket.close()},t&&n.connect(t),n.getTopics=function(e){var t=new n.Service({name:"/rosapi/topics",serviceType:"rosapi/Topics"}),r=new n.ServiceRequest;t.callService(r,function(t){e(t.topics)})},n.Message=function(e){var t=this;e&&Object.keys(e).forEach(function(n){t[n]=e[n]})},n.Topic=function(e){var t=this;e=e||{},t.node=e.node,t.name=e.name,t.messageType=e.messageType,t.isAdvertised=!1,t.compression=e.compression||"none",t.throttle_rate=e.throttle_rate||0,t.compression&&t.compression!=="png"&&t.compression!=="none"&&t.emit("warning",t.compression+" compression is not supported. No comression will be used."),t.throttle_rate<0&&(t.emit("warning",t.throttle_rate+" is not allowed. Set to 0"),t.throttle_rate=0),t.subscribe=function(e){t.on("message",function(t){e(t)}),n.on(t.name,function(e){var r=new n.Message(e);t.emit("message",r)}),n.idCounter++;var r="subscribe:"+t.name+":"+n.idCounter,i={op:"subscribe",id:r,type:t.messageType,topic:t.name,compression:t.compression,throttle_rate:t.throttle_rate};a(i)},t.unsubscribe=function(){n.removeAllListeners([t.name]),n.idCounter++;var e="unsubscribe:"+t.name+":"+n.idCounter,r={op:"unsubscribe",id:e,topic:t.name};a(r)},t.advertise=function(){n.idCounter++;var e="advertise:"+t.name+":"+n.idCounter,r={op:"advertise",id:e,type:t.messageType,topic:t.name};a(r),t.isAdvertised=!0},t.unadvertise=function(){n.idCounter++;var e="unadvertise:"+t.name+":"+n.idCounter,r={op:"unadvertise",id:e,topic:t.name};a(r),t.isAdvertised=!1},t.publish=function(e){t.isAdvertised||t.advertise(),n.idCounter++;var r="publish:"+t.name+":"+n.idCounter,i={op:"publish",id:r,topic:t.name,msg:e};a(i)}},n.Topic.prototype.__proto__=e.prototype,n.getServices=function(e){var t=new n.Service({name:"/rosapi/services",serviceType:"rosapi/Services"}),r=new n.ServiceRequest;t.callService(r,function(t){e(t.services)})},n.ServiceRequest=function(e){var t=this;e&&Object.keys(e).forEach(function(n){t[n]=e[n]})},n.ServiceResponse=function(e){var t=this;e&&Object.keys(e).forEach(function(n){t[n]=e[n]})},n.Service=function(e){var t=this;e=e||{},t.name=e.name,t.serviceType=e.serviceType,t.callService=function(e,r){n.idCounter++,serviceCallId="call_service:"+t.name+":"+n.idCounter,n.once(serviceCallId,function(e){var t=new n.ServiceResponse(e);r(t)});var i=[];Object.keys(e).forEach(function(t){i.push(e[t])});var s={op:"call_service",id:serviceCallId,service:t.name,args:i};a(s)}},n.Service.prototype.__proto__=e.prototype,n.getParams=function(e){var t=new n.Service({name:"/rosapi/get_param_names",serviceType:"rosapi/GetParamNames"}),r=new n.ServiceRequest;t.callService(r,function(t){e(t.names)})},n.Param=function(e){var t=this;e=e||{},t.name=e.name,t.get=function(e){var r=new n.Service({name:"/rosapi/get_param",serviceType:"rosapi/GetParam"}),i=new n.ServiceRequest({name:t.name,value:JSON.stringify("")});r.callService(i,function(t){var n=JSON.parse(t.value);e(n)})},t.set=function(e){var r=new n.Service({name:"/rosapi/set_param",serviceType:"rosapi/SetParam"}),i=new n.ServiceRequest({name:t.name,value:JSON.stringify(e)});r.callService(i,function(){})}},n.Param.prototype.__proto__=e.prototype};return t.prototype.__proto__=e.prototype,t}),function(e,t){typeof define=="function"&&define.amd?define(["eventemitter2"],t):e.ActionClient=t(e.EventEmitter2)}(this,function(e){var t=function(t){var n=this;t=t||{},n.ros=t.ros,n.serverName=t.serverName,n.actionName=t.actionName,n.timeout=t.timeout,n.goals={},n.goalTopic=new n.ros.Topic({name:n.serverName+"/goal",messageType:n.actionName+"Goal"}),n.goalTopic.advertise(),n.cancelTopic=new n.ros.Topic({name:n.serverName+"/cancel",messageType:"actionlib_msgs/GoalID"}),n.cancelTopic.advertise();var r=!1,i=new n.ros.Topic({name:n.serverName+"/status",messageType:"actionlib_msgs/GoalStatusArray"});i.subscribe(function(e){r=!0,e.status_list.forEach(function(e){var t=n.goals[e.goal_id.id];t&&t.emit("status",e)})}),n.timeout&&setTimeout(function(){r||n.emit("timeout")},n.timeout);var s=new n.ros.Topic({name:n.serverName+"/feedback",messageType:n.actionName+"Feedback"});s.subscribe(function(e){var t=n.goals[e.status.goal_id.id];t&&(t.emit("status",e.status),t.emit("feedback",e.feedback))});var o=new n.ros.Topic({name:n.serverName+"/result",messageType:n.actionName+"Result"});o.subscribe(function(e){var t=n.goals[e.status.goal_id.id];t&&(t.emit("status",e.status),t.emit("result",e.result))}),n.cancel=function(){var e=new n.ros.Message({});n.cancelTopic.publish(e)},n.Goal=function(e){var t=this;t.isFinished=!1,t.status,t.result,t.feedback;var r=new Date;t.goalId="goal_"+Math.random()+"_"+r.getTime(),t.goalMessage=new n.ros.Message({goal_id:{stamp:{secs:0,nsecs:0},id:t.goalId},goal:e}),t.on("status",function(e){t.status=e}),t.on("result",function(e){t.isFinished=!0,t.result=e}),t.on("feedback",function(e){t.feedback=e}),n.goals[t.goalId]=this,t.send=function(e){n.goalTopic.publish(t.goalMessage),e&&setTimeout(function(){t.isFinished||t.emit("timeout")},e)},t.cancel=function(){var e=new n.ros.Message({id:t.goalId});n.cancelTopic.publish(e)}},n.Goal.prototype.__proto__=e.prototype};return t.prototype.__proto__=e.prototype,t}),function(e,t){typeof define=="function"&&define.amd?define(["eventemitter2","actionclient","map"],t):e.Nav2D=t(e.EventEmitter2,e.ActionClient,e.Map)}(this,function(e,t,n){var r=function(e){var r=this;e=e||{},r.ros=e.ros,r.serverName=e.serverName||"/move_base",r.actionName=e.actionName||"move_base_msgs/MoveBaseAction",r.serverTimeout=e.serverTimeout||5e3,r.mapTopic=e.mapTopic||"/map",r.continuous=e.continuous,r.canvasID=e.canvasID,r.image=e.image,r.mapMetaTopic=e.mapMetaTopic||"/map_metadata",r.clickColor=e.clickColor||"#543210",r.robotColor=e.robotColor||"#012345",r.initialPoseTopic=e.initialPoseTopic||"/initialpose",r.readOnly=e.readOnly,r.drawrobot=e.drawrobot,r.mode="none",r.robotPose=null,r.goalMessage=null;var i=1,s=!0,o=5,u=1,a=!0,f=10,l,c,h,p,d,v=null,m=null,g=null,y=null,b,w,E,S=!1,x=document.getElementById(r.canvasID);if(r.image){v=new Image,v.src=r.image;var T=new r.ros.Topic({name:r.mapMetaTopic,messageType:"nav_msgs/MapMetaData"});T.subscribe(function(e){m=e.width,g=e.height,y=e.resolution,b=e.origin.position.x,w=e.origin.position.y,T.unsubscribe()})}else{var N=new n({ros:r.ros,mapTopic:r.mapTopic,continuous:r.continuous});N.on("available",function(){v=N.image,m=N.info.width,g=N.info.height,y=N.info.resolution,b=N.info.origin.position.x,w=N.info.origin.position.y})}var C=new r.ros.Topic({name:"/robot_pose",messageType:"geometry_msgs/Pose",throttle_rate:100});C.subscribe(function(e){r.robotPose=e;if(m&&g&&y){var t=x.getAttribute("width"),n=x.getAttribute("height");l=(e.position.x-b)/y*(t/m),c=n-(e.position.y-w)/y*(n/g);var i=e.orientation.w,s=e.orientation.x,o=e.orientation.y,u=e.orientation.z;h=-Math.atan2(2*(i*u+s*o),1-2*(Math.pow(o,2)+Math.pow(u,2))),S||(S=!0,r.emit("available"))}});var k=new t({ros:r.ros,actionName:r.actionName,serverName:r.serverName,timeout:r.serverTimeout});k.on("timeout",function(){r.emit("timeout")}),r.cancel=function(){k.cancel()},r.drawrobot=r.drawrobot||function(e,t,n){e.fillStyle=r.robotColor,e.beginPath(),e.arc(t,n,u,0,Math.PI*2,!0),e.closePath(),e.fill(),a?u++:u--;if(u==f||u==1)a=!a};var L=function(){var e=x.getContext("2d"),t=x.getAttribute("width"),n=x.getAttribute("height"),u="";if(!v)u="Waiting for the robot's internal map...";else if(!y)u="Waiting for the robot's map metadata...";else if(!l||!c)u="Waiting for the robot's position...";e.clearRect(0,0,t,n),u.length===0?(e.drawImage(v,0,0,t,n),p&&d&&r.mode=="none"&&(e.fillStyle=r.clickColor,e.beginPath(),e.arc(p,d,i,0,Math.PI*2,!0),e.closePath(),e.fill(),s&&i++,i==o&&(i=1),s=!s),r.drawrobot(e,l,c,h)):(x.style.background="#333333",e.lineWidth=4,e.fillStyle="#ffffff",e.font="40px sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillText(u,t/2,n/2))};r.getPoseFromEvent=function(e){if(S){var t=0,n=0,r=x;while(r&&!isNaN(r.offsetLeft)&&!isNaN(r.offsetTop))t+=r.offsetLeft-r.scrollLeft,n+=r.offsetTop-r.scrollTop,r=r.offsetParent;p=e.pageX-t,d=e.pageY-n;var i=x.getAttribute("width"),s=x.getAttribute("height"),o=p*(m/i)*y+b,u=(s-d)*(g/s)*y+w;return[o,u]}return null},r.sendGoalPose=function(e,t){var n=new k.Goal({target_pose:{header:{frame_id:"/map"},pose:{position:{x:e,y:t,z:0},orientation:{x:0,y:0,z:0,w:1}}}});n.send(),r.goalMessage=n.goalMessage,n.on("result",function(e){r.emit("result",e),r.mode="none",p=null,d=null}),n.on("status",function(e){r.emit("status",e)}),n.on("feedback",function(e){r.emit("feedback",e)})},x.addEventListener("click",function(e){if(r.mode!="none")if(r.mode=="init"){var t=r.getPoseFromEvent(e);t!=null?r.sendInitPose(t[0],t[1]):r.emit("error","All of the necessary navigation information is not yet available.")}else if(r.mode=="goal"){var t=r.getPoseFromEvent(e);t!=null?r.sendGoalPose(t[0],t[1]):r.emit("error","All of the necessary navigation information is not yet available.")}else r.emit("error","Wrong mode..");r.mode="none"}),r.setmode=function(e){r.mode=e,p=null,d=null},r.initPosePub=new r.ros.Topic({name:r.initialPoseTopic,type:"geometry_msgs/PoseWithCovarianceStamped"}),r.sendInitPose=function(e,t){var n=new ros.Message({header:{frame_id:"/map"},pose:{pose:{position:{x:e,y:t,z:0},orientation:{x:0,y:0,z:0,w:1}},covariance:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}});r.initPosePub.publish(n),r.setmode("none")},r.readOnly||x.addEventListener("dblclick",function(e){var t=r.getPoseFromEvent(e);t!=null?r.sendGoalPose(t[0],t[1]):r.emit("error","All of the necessary navigation information is not yet available.")}),E=setInterval(L,30)};return r.prototype.__proto__=e.prototype,r});